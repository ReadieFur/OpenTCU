<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inject CAN</title>
</head>
<body>
    <label for="file_picker">Select dump</label><input type="file" id="file_picker" accept=".txt" name="Select dump"/>
    <br><br>
    <label for="channel">Channel filter</label>
    <form id="channel">
        <input type="radio" id="channel_both" name="channel" checked><label for="channel_both">SPI & TWAI</label><br>
        <input type="radio" id="channel_spi" name="channel"><label for="channel_spi">SPI</label><br>
        <input type="radio" id="channel_twai" name="channel"><label for="channel_twai">TWAI</label>
    </form>
    <br>
    <button id="inject">Inject</button>
    <br><br>
    <!-- <label for="running">Is Running</label><input type="checkbox" id="running" readonly/> -->

    <script>
        var inject = document.getElementById("inject");
        // var running = document.getElementById("running");
        var channelBoth = document.getElementById("channel_both");
        var channelSpi = document.getElementById("channel_spi");
        var channelTwai = document.getElementById("channel_twai");
        var filePicker = document.getElementById("file_picker");
        var fileData = null;

        filePicker.addEventListener("change", function(event)
        {
            var reader = new FileReader();
            reader.onload = function(event)
            {
                var text = event.target.result;
                //Format the data.
                var lines = text.split("\n");
                var data = [];
                for (var i = 0; i < lines.length; i++)
                {
                    //#region Validate line
                    var line = lines[i];
                    var parts = line.split(",");
                    if (parts.length != 14)
                        continue;
                    //#endregion

                    //#region Convert the timestamp to offsets
                    if (i == 0)
                    {
                        parts[0] = 0;
                    }
                    else
                    {
                        var prevLine = lines[i - 1];
                        var prevParts = prevLine.split(",");
                        var prevTime = prevParts[0];
                        var time = parts[0];
                        var offset = time - prevTime;
                        parts[0] = offset;
                    }
                    //#endregion

                    //#region Remove newline character from the last part
                    var lastPart = parts[parts.length - 1];
                    parts[parts.length - 1] = lastPart.substring(0, lastPart.length - 1);
                    //#endregion
                        
                    data.push(parts);
                }
                fileData = data;
                console.table(fileData);
            };
            reader.readAsText(event.target.files[0]);
        });

        function FilterByChannel(id)
        {
            var filtered = [];
            for (var i = 0; i < fileData.length; i++)
            {
                var entry = fileData[i];
                if (entry[1] == id)
                    continue;
                filtered.push(entry);
            }
            fileData = filtered;
        }

        inject.addEventListener("click", function(event)
        {
            if (fileData == null)
            {
                alert("Please select a file");
                return;
            }

            //#region Filter by channel
            if (channelBoth.checked)
            {
                //Do nothing.
            }
            else if (channelSpi.checked)
            {
                //Remove all entries where [1] is 0.
                FilterByChannel(0);
            }
            else if (channelTwai.checked)
            {
                //Remove all entries where [1] is 1.
                FilterByChannel(1);
            }
            console.table(fileData);
            //#endregion

            //#region Inject
            //Convert data to a string.
            var data = "";
            for (var i = 0; i < fileData.length; i++)
            {
                var entry = fileData[i];
                for (var j = 0; j < entry.length; j++)
                {
                    var value = entry[j];
                    data += value;
                    if (j != entry.length - 1)
                        data += ",";
                }
                if (i != fileData.length - 1)
                    data += "\n";
                    // data += "|";
            }
            console.log(data);

            //Post to /inject
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/inject", true);
            xhr.setRequestHeader("Content-Type", "text/plain");
            xhr.onreadystatechange = function()
            {
                if (xhr.readyState == 4 && xhr.status == 200)
                {
                    console.log(xhr.responseText);
                }
            };
            xhr.send(data);
            //#endregion
        });
    </script>
</body>
</html>
